# 模拟流程与执行周期

<cite>
**本文档引用文件**  
- [main.py](file://main.py)
- [Market.py](file://Market.py)
- [Person.py](file://Person.py)
- [Stock.py](file://Stock.py)
- [behavior.py](file://behavior.py)
- [database_utils.py](file://database_utils.py)
- [load_json.py](file://load_json.py)
- [constant.py](file://constant.py)
</cite>

## 目录
1. [简介](#简介)
2. [模拟周期总体流程](#模拟周期总体流程)
3. [主控执行流程](#主控执行流程)
4. [每日迭代阶段分解](#每日迭代阶段分解)
5. [核心闭环流程](#核心闭环流程)
6. [迭代控制与终止条件](#迭代控制与终止条件)
7. [模拟周期配置方法](#模拟周期配置方法)

## 简介
本项目实现了一个基于智能体的股票交易模拟系统，通过LLM驱动的智能体进行市场分析、决策、交易和反思。系统从day0开始，按时间步长驱动每日迭代，完整模拟交易周期。本文档详细描述了整个执行流程，包括市场状态更新、智能体感知、LLM决策、订单生成、市场撮合、状态更新和反思优化的闭环过程。

## 模拟周期总体流程
系统模拟从虚拟日期day0开始，按照预设的交易天数和每日迭代次数执行完整的交易周期。每个交易日包含多个迭代步骤，每个步骤中智能体依次进行市场分析、决策、订单提交、交易执行、信息传播和反思优化。市场状态在每个迭代步骤中更新，形成一个完整的反馈闭环。

```mermaid
flowchart TD
Start([开始模拟]) --> Init["初始化系统<br/>加载智能体、股票、市场数据"]
Init --> DayLoop["进入每日循环<br/>virtual_date从0到No_Days-1"]
DayLoop --> IPO["第0天执行IPO<br/>broker.ipo(virtual_date)"]
IPO --> MarketIndex["更新市场指数<br/>market_index.update_market_index()"]
MarketIndex --> Gossip["生成市场八卦<br/>generate_gossip()"]
Gossip --> IterLoop["进入每日迭代循环<br/>iter从0到Iterations_Daily-1"]
IterLoop --> Analysis["市场分析与智能体决策<br/>stock_ops()"]
Analysis --> Order["随机顺序提交订单<br/>persons[i].create_order()"]
Order --> Match["市场撮合交易<br/>market.match_order()"]
Match --> EndMarket["市场迭代结束处理<br/>market.end_of_market()"]
EndMarket --> UpdateIndex["更新市场指数<br/>market_index.update_market_index()"]
UpdateIndex --> EndIter["智能体迭代结束处理<br/>each_person.end_of_iteration()"]
EndIter --> Reflect["执行反思流程<br/>reflection()"]
Reflect --> Save["保存当前状态<br/>save_all()"]
Save --> IterLoop
IterLoop --> EndDay["日终处理<br/>market.end_of_day()"]
EndDay --> PersonEndDay["智能体日终处理<br/>each_person.end_of_day()"]
PersonEndDay --> StockEndDay["股票日终处理<br/>each_stock.end_of_day()"]
StockEndDay --> MarketIndexEndDay["市场指数日终处理<br/>market_index.end_of_day()"]
MarketIndexEndDay --> DayLoop
DayLoop --> End["结束模拟"]
```

**Diagram sources**
- [main.py](file://main.py#L110-L147)

## 主控执行流程
系统通过`main.py`中的`overall_test`函数驱动整个模拟流程。该函数首先调用`init_all`初始化系统，然后进入双重循环：外层循环控制交易天数，内层循环控制每日的迭代次数。

```mermaid
flowchart TD
Main["main()入口"] --> GetArgs["获取命令行参数<br/>get_args()"]
GetArgs --> InitAll["初始化系统<br/>init_all(args)"]
InitAll --> DayLoop["for virtual_date in range(args.No_Days)"]
DayLoop --> IsDay0{"virtual_date == 0?"}
IsDay0 --> |是| IPO["执行IPO<br/>broker.ipo(virtual_date)"]
IsDay0 --> |否| UpdateIndex1["更新市场指数<br/>market_index.update_market_index()"]
IPO --> UpdateIndex1
UpdateIndex1 --> Gossip["生成八卦<br/>generate_gossip()"]
Gossip --> IterLoop["for iter in range(args.Iterations_Daily)"]
IterLoop --> StockOps["获取股票操作<br/>stock_ops()"]
StockOps --> RandomOrder["随机排序智能体"]
RandomOrder --> ProcessOps["处理每个智能体的操作"]
ProcessOps --> CreateOrder["创建订单<br/>create_order()"]
CreateOrder --> MatchOrder["市场撮合<br/>market.match_order()"]
MatchOrder --> EndMarket["市场结束处理<br/>end_of_market()"]
EndMarket --> UpdateIndex2["更新市场指数<br/>update_market_index()"]
UpdateIndex2 --> EndIter["智能体结束处理<br/>end_of_iteration()"]
EndIter --> Reflect["执行反思<br/>reflection()"]
Reflect --> Save["保存状态<br/>save_all()"]
Save --> IterLoop
IterLoop --> EndDay["日终处理<br/>end_of_day()"]
EndDay --> End["结束"]
```

**Section sources**
- [main.py](file://main.py#L99-L150)

## 每日迭代阶段分解
每个交易日的迭代过程包含多个关键阶段，按顺序执行：

### 市场分析与智能体决策
在每个迭代开始时，系统调用`stock_ops`函数，触发所有智能体进行市场分析和决策。该函数为每个智能体生成分析结果和八卦信息，并通过LLM生成买入和卖出决策。

```mermaid
flowchart TD
StockOps["stock_ops()"] --> ForEachPerson["遍历每个智能体"]
ForEachPerson --> Analysis["执行分析<br/>analysis()"]
Analysis --> Gossip["获取八卦<br/>gossip"]
Analysis --> ChooseBuy["选择买入股票<br/>run_gpt_prompt_choose_buy_stock()"]
ChooseBuy --> ExtractBuy["提取买入决策<br/>extract_for_choose_buy()"]
ExtractBuy --> ChooseSell["选择卖出股票<br/>run_gpt_prompt_choose_sell_stock()"]
ChooseSell --> ExtractSell["提取卖出决策<br/>extract_for_choose_sell()"]
ExtractSell --> AddMemory["添加记忆记录<br/>add_memory()"]
AddMemory --> ReturnOps["返回操作列表"]
```

**Section sources**
- [behavior.py](file://behavior.py#L82-L171)

### 订单提交与市场撮合
智能体决策后，系统按照随机顺序让智能体提交订单，然后由市场对象执行撮合。

```mermaid
flowchart TD
SubmitOrder["提交订单"] --> RandomSample["随机采样智能体顺序<br/>random.sample()"]
RandomSample --> ForEachPerson["遍历每个智能体"]
ForEachPerson --> CreateOrder["创建订单<br/>create_order()"]
CreateOrder --> Extract["提取操作参数"]
Extract --> IsBuy{"操作类型是买入?"}
IsBuy --> |是| CheckCash["检查现金是否充足"]
CheckCash --> |是| SubmitBuy["提交买入订单<br/>submit_order()"]
IsBuy --> |否| IsSell{"操作类型是卖出?"}
IsSell --> |是| CheckStock["检查持股数量"]
CheckStock --> |是| SubmitSell["提交卖出订单<br/>submit_order()"]
SubmitBuy --> NextPerson
SubmitSell --> NextPerson
NextPerson --> ForEachPerson
ForEachPerson --> End["结束"]
```

**Section sources**
- [Person.py](file://Person.py#L212-L249)
- [database_utils.py](file://database_utils.py#L224-L243)

### 交易执行与状态更新
市场撮合完成后，系统更新交易状态和各方资产。

```mermaid
flowchart TD
MatchOrder["market.match_order()"] --> ForEachStock["遍历每只股票"]
ForEachStock --> FetchOrders["获取买卖订单<br/>_fetch_orders()"]
FetchOrders --> WhileLoop["while current_buy and current_sell"]
WhileLoop --> PriceCheck["检查价格波动是否超限"]
PriceCheck --> |否| CalculateTrade["计算交易量和价格"]
CalculateTrade --> UpdatePrice["更新股票价格"]
UpdatePrice --> UpdateOrders["更新订单状态<br/>_update_order()"]
UpdateOrders --> CheckResidual["检查剩余订单"]
CheckResidual --> |有| UpdateResidual["更新剩余订单"]
CheckResidual --> |无| Continue["继续撮合"]
Continue --> WhileLoop
WhileLoop --> End["结束撮合"]
End --> ForEachStock
ForEachStock --> EndAll["结束"]
```

**Section sources**
- [Market.py](file://Market.py#L96-L198)

## 核心闭环流程
系统实现了"市场状态 → 智能体感知 → LLM决策 → 订单生成 → 市场撮合 → 状态更新 → 反思优化"的完整闭环。

```mermaid
flowchart LR
MarketState["市场状态"] --> AgentPerception["智能体感知"]
AgentPerception --> LLMDecision["LLM决策"]
LLMDecision --> OrderGeneration["订单生成"]
OrderGeneration --> MarketMatching["市场撮合"]
MarketMatching --> StateUpdate["状态更新"]
StateUpdate --> Reflection["反思优化"]
Reflection --> MarketState
```

该闭环在每个迭代步骤中执行，确保了模拟的连续性和反馈性。智能体通过`query_hold_stocks`、`query_account`等方法感知市场状态，通过LLM生成决策，提交订单后由市场撮合，更新状态后进行反思优化。

**Diagram sources**
- [Person.py](file://Person.py#L429-L439)
- [behavior.py](file://behavior.py#L82-L171)
- [Market.py](file://Market.py#L96-L198)

## 迭代控制与终止条件
系统的迭代控制通过双重循环实现，外层循环控制交易天数，内层循环控制每日迭代次数。

### 终止条件
1. **天数终止条件**：当`virtual_date`达到`args.No_Days`时，外层循环结束
2. **迭代终止条件**：当`iter`达到`args.Iterations_Daily`时，内层循环结束
3. **异常终止条件**：数据库操作异常或系统错误

### 反思频率控制
智能体的反思频率由`reflect_frequency`参数控制，只有当`(iter + 1) % p.reflect_frequency == 0`时才执行反思。

```mermaid
flowchart TD
Reflection["reflection()"] --> ForEachPerson["遍历每个智能体"]
ForEachPerson --> HasFrequency{"reflect_frequency > 0?"}
HasFrequency --> |是| CheckIteration{"(iter + 1) % reflect_frequency == 0?"}
CheckIteration --> |是| PreReflect["执行预反思<br/>pre_reflect()"]
PreReflect --> ExtractWS["提取优缺点<br/>extract_analysis_for_reflect()"]
ExtractWS --> LongReflect["执行长期反思<br/>long_reflect()"]
LongReflect --> UpdateStrategy["更新策略<br/>update_strategy()"]
UpdateStrategy --> ExtractNew["提取新策略<br/>extract_strategy()"]
ExtractNew --> UpdatePrinciple["更新原则<br/>p.principle = new_strategy"]
UpdatePrinciple --> AddMemory["添加记忆记录"]
AddMemory --> End
CheckIteration --> |否| End
HasFrequency --> |否| End
```

**Section sources**
- [behavior.py](file://behavior.py#L174-L198)

## 模拟周期配置方法
用户可以通过命令行参数自定义模拟周期长度和迭代频率。

### 配置参数
以下参数可在`get_args`函数中配置：

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `--Iterations_Daily` | 3 | 每日迭代次数 |
| `--No_Days` | 3 | 交易天数 |
| `--Num_Person` | 9 | 智能体数量 |
| `--Num_Stock` | 3 | 股票数量 |
| `--SAVE_NAME` | None | 保存文件夹名称 |
| `--Daily_Price_Limit` | 0.7 | 每日价格变动限制 |
| `--expense_ratio` | 0.03 | 资本成本率 |
| `--Fluctuation_Constant` | 20.0 | 价格波动常数 |
| `--analysis_num` | 3 | 执行分析的智能体数量 |
| `--gossip_num_max` | 3 | 每轮八卦最大数量 |

### 配置示例
```bash
python main.py --No_Days 5 --Iterations_Daily 10 --Num_Person 5
```

此命令将模拟5个交易日，每天10次迭代，使用5个智能体。

**Section sources**
- [main.py](file://main.py#L17-L63)