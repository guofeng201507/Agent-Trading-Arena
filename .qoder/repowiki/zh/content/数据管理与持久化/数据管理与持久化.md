# 数据管理与持久化

<cite>
**本文档引用的文件**   
- [database.py](file://Agent-Trading-Arena/Stock_Main/database.py)
- [database_utils.py](file://Agent-Trading-Arena/Stock_Main/database_utils.py)
- [load_json.py](file://Agent-Trading-Arena/Stock_Main/load_json.py)
- [persona.json](file://Agent-Trading-Arena/Stock_Main/save/init/persona.json)
- [stocks.json](file://Agent-Trading-Arena/Stock_Main/save/init/stocks.json)
- [information.json](file://Agent-Trading-Arena/Stock_Main/save/sim_test01/information.json)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本项目采用混合持久化策略，结合SQLite数据库与JSON文件存储，实现交易代理系统的状态管理。系统通过`database.py`和`database_utils.py`管理运行时操作数据，使用`load_json.py`加载初始配置，并将模拟状态序列化到`save/`目录下的独立运行子目录中。该设计支持模拟的保存、恢复、调试和分析功能。

## 项目结构

```mermaid
graph TD
subgraph "数据管理"
database[database.py]
db_utils[database_utils.py]
load_json[load_json.py]
end
subgraph "配置与保存"
init[init/]
save[save/]
classes[classes/]
end
subgraph "数据文件"
persona[persona.json]
stocks[stocks.json]
info[information.json]
pkl[*.pkl]
end
database --> save
db_utils --> save
load_json --> init
load_json --> save
init --> persona
init --> stocks
save --> info
save --> classes
```

**图示来源**
- [database.py](file://Agent-Trading-Arena/Stock_Main/database.py#L1-L133)
- [database_utils.py](file://Agent-Trading-Arena/Stock_Main/database_utils.py#L1-L322)
- [load_json.py](file://Agent-Trading-Arena/Stock_Main/load_json.py#L1-L134)

**本节来源**
- [database.py](file://Agent-Trading-Arena/Stock_Main/database.py#L1-L133)
- [database_utils.py](file://Agent-Trading-Arena/Stock_Main/database_utils.py#L1-L322)
- [load_json.py](file://Agent-Trading-Arena/Stock_Main/load_json.py#L1-L134)

## 核心组件

系统通过`database.py`和`database_utils.py`实现SQLite数据库操作，`load_json.py`负责JSON配置的加载与对象序列化。`database_utils.py`定义了主要的数据库模式，包括`active_orders`、`stock`、`person`、`account`、`memory`和`gossip`等表，用于持久化交易、账户和代理状态。

**本节来源**
- [database.py](file://Agent-Trading-Arena/Stock_Main/database.py#L1-L133)
- [database_utils.py](file://Agent-Trading-Arena/Stock_Main/database_utils.py#L1-L322)
- [load_json.py](file://Agent-Trading-Arena/Stock_Main/load_json.py#L1-L134)

## 架构概述

```mermaid
graph TB
subgraph "初始化"
init_json[init/persona.json]
init_stocks[init/stocks.json]
load_json_module[load_json.py]
end
subgraph "运行时数据"
sqlite_db[data.db]
database_utils[database_utils.py]
end
subgraph "持久化存储"
save_dir[save/run_xxx/]
info_json[information.json]
classes_dir[classes/]
pkl_files[*.pkl]
end
subgraph "调试与分析"
debug_prompts[debug_prompts/]
text_files[*.txt]
end
init_json --> load_json_module
init_stocks --> load_json_module
load_json_module --> save_dir
database_utils --> sqlite_db
sqlite_db --> save_dir
save_dir --> info_json
save_dir --> classes_dir
save_dir --> debug_prompts
classes_dir --> pkl_files
```

**图示来源**
- [database_utils.py](file://Agent-Trading-Arena/Stock_Main/database_utils.py#L245-L322)
- [load_json.py](file://Agent-Trading-Arena/Stock_Main/load_json.py#L25-L77)
- [save/](file://Agent-Trading-Arena/Stock_Main/save/)

## 详细组件分析

### 数据库管理分析

系统使用SQLite数据库存储结构化运行时数据。`database_utils.py`中的`Database_operate`类负责初始化数据库并创建多个表。

```mermaid
erDiagram
active_orders {
Integer timestamp PK
Integer virtual_date
INTEGER weekday
INTEGER iteration
INTEGER stock_id
INTEGER person_id
text type
Numeric price
INTEGER quantity
text status
}
stock {
Integer stock_id PK
Integer virtual_date
INTEGER weekday
Numeric volume
INTEGER quantity
Numeric last_price
Numeric begin_price
Numeric highest_price
Numeric lowest_price
}
person {
Integer person_id
Integer virtual_date
Numeric cash
Numeric asset
Numeric wealth
Numeric work_income
Numeric capital_gain
Numeric daily_expense
Text principle
}
account {
Integer person_id
Integer stock_id
Integer virtual_date
INTEGER weekday
INTEGER quantity
Numeric cost_price
Numeric current_price
Numeric profit
INTEGER start_date
}
memory {
Integer person_id
Integer virtual_date
INTEGER iteration
Text stock_operations
Text strategy
Text type
Text gossip
Text analysis_for_stocks
Text analysis_for_strategy
Text stock_prices
Text market_change
Text financial_situation
}
gossip {
Integer person_id
Integer virtual_date
Text gossip
}
```

**图示来源**
- [database_utils.py](file://Agent-Trading-Arena/Stock_Main/database_utils.py#L253-L300)

**本节来源**
- [database_utils.py](file://Agent-Trading-Arena/Stock_Main/database_utils.py#L1-L322)

### JSON配置加载分析

`load_json.py`模块负责加载初始配置和序列化/反序列化运行时对象。

```mermaid
sequenceDiagram
participant Main as 主程序
participant LoadJson as load_json.py
participant FileSystem as 文件系统
Main->>LoadJson : load_all(args)
LoadJson->>FileSystem : 读取 information.json
FileSystem-->>LoadJson : 虚拟日期, 迭代次数
LoadJson->>FileSystem : 读取 MARKET.pkl
FileSystem-->>LoadJson : 反序列化市场对象
LoadJson->>FileSystem : 读取 PERSON_*.pkl
FileSystem-->>LoadJson : 反序列化代理对象
LoadJson->>FileSystem : 读取 STOCK_*.pkl
FileSystem-->>LoadJson : 反序列化股票对象
LoadJson->>Main : 返回所有对象
```

**图示来源**
- [load_json.py](file://Agent-Trading-Arena/Stock_Main/load_json.py#L81-L122)

**本节来源**
- [load_json.py](file://Agent-Trading-Arena/Stock_Main/load_json.py#L1-L134)

### 初始配置文件分析

`init/`目录包含系统启动所需的初始配置文件。

```mermaid
flowchart TD
A[persona.json] --> B[person_id: 代理唯一标识]
A --> C[name: 代理姓名]
A --> D[occupation: 职业]
A --> E[principle: 投资原则]
A --> F[investment_duration: 投资期限]
A --> G[daily_income_from_job: 日收入]
A --> H[cash: 初始现金]
A --> I[minimum_living_expense: 最低生活开支]
A --> J[reflect_frequency: 反思频率]
K[stocks.json] --> L[stock_id: 股票唯一标识]
K --> M[stock_name: 股票名称]
K --> N[DPS: 每股分红]
K --> O[past_stock_last_prices: 历史收盘价]
K --> P[quantity: 总股本]
```

**图示来源**
- [init/persona.json](file://Agent-Trading-Arena/Stock_Main/save/init/persona.json)
- [init/stocks.json](file://Agent-Trading-Arena/Stock_Main/save/init/stocks.json)

**本节来源**
- [init/persona.json](file://Agent-Trading-Arena/Stock_Main/save/init/persona.json)
- [init/stocks.json](file://Agent-Trading-Arena/Stock_Main/save/init/stocks.json)

## 依赖分析

```mermaid
graph TD
load_json --> database_utils
load_json --> pickle
load_json --> json
database_utils --> sqlite3
database_utils --> json
database --> sqlite3
database --> database_utils
```

**图示来源**
- [load_json.py](file://Agent-Trading-Arena/Stock_Main/load_json.py#L6)
- [database_utils.py](file://Agent-Trading-Arena/Stock_Main/database_utils.py#L1)
- [database.py](file://Agent-Trading-Arena/Stock_Main/database.py#L1)

**本节来源**
- [load_json.py](file://Agent-Trading-Arena/Stock_Main/load_json.py#L1-L134)
- [database_utils.py](file://Agent-Trading-Arena/Stock_Main/database_utils.py#L1-L322)
- [database.py](file://Agent-Trading-Arena/Stock_Main/database.py#L1-L133)

## 性能考虑
系统采用混合持久化策略，在性能和可调试性之间取得平衡。SQLite数据库提供高效的结构化数据查询，而Pickle序列化确保复杂对象状态的完整保存。JSON文件用于轻量级配置，便于人工编辑和版本控制。对于大规模模拟，建议定期备份`save/`目录以防止数据丢失。

## 故障排除指南

当遇到数据管理问题时，请检查以下方面：
1. 确认`save/`目录有写入权限
2. 验证`init/`目录中的JSON文件格式正确
3. 检查`data.db`数据库文件是否被正确创建
4. 确保`classes/`目录存在且可写
5. 查看`debug_prompts/`中的日志文件以获取调试信息

**本节来源**
- [save/](file://Agent-Trading-Arena/Stock_Main/save/)
- [init/](file://Agent-Trading-Arena/Stock_Main/save/init/)

## 结论
本系统实现了完整的数据管理与持久化机制，支持模拟的保存、恢复和分析。通过SQLite、JSON和Pickle的组合使用，系统在数据完整性、查询效率和可调试性方面达到了良好平衡。建议定期备份`save/`目录中的运行数据，并利用`debug_prompts/`中的日志进行问题诊断。