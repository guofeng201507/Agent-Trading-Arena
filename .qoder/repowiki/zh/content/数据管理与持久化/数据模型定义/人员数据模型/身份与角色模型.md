# 身份与角色模型

<cite>
**本文档引用文件**  
- [Person.py](file://Agent-Trading-Arena/Stock_Main/Person.py)
- [load_json.py](file://Agent-Trading-Arena/Stock_Main/load_json.py)
- [constant.py](file://Agent-Trading-Arena/Stock_Main/constant.py)
- [persona.json](file://Agent-Trading-Arena/Stock_Main/save/sim_test01/persona.json)
- [analysis.txt](file://Agent-Trading-Arena/Stock_Main/content/our_prompt_template/analysis.txt)
- [gossip.txt](file://Agent-Trading-Arena/Stock_Main/content/our_prompt_template/gossip.txt)
- [pre_reflect.txt](file://Agent-Trading-Arena/Stock_Main/content/our_prompt_template/pre_reflect.txt)
- [reflect.txt](file://Agent-Trading-Arena/Stock_Main/content/our_prompt_template/reflect.txt)
- [buy_based_on_analysis.txt](file://Agent-Trading-Arena/Stock_Main/content/our_prompt_template/buy_based_on_analysis.txt)
- [sell_based_on_analysis.txt](file://Agent-Trading-Arena/Stock_Main/content/our_prompt_template/sell_based_on_analysis.txt)
- [behavior.py](file://Agent-Trading-Arena/Stock_Main/behavior.py)
- [our_run_gpt_prompt.py](file://Agent-Trading-Arena/Stock_Main/content/our_run_gpt_prompt.py)
</cite>

## 目录
1. [引言](#引言)
2. [身份属性与角色类型](#身份属性与角色类型)
3. [身份初始化过程](#身份初始化过程)
4. [身份对行为模式的影响](#身份对行为模式的影响)
5. [角色权限与功能差异](#角色权限与功能差异)
6. [身份信息与提示模板的联动机制](#身份信息与提示模板的联动机制)
7. [模拟周期中的身份作用](#模拟周期中的身份作用)
8. [结论](#结论)

## 引言
在Agent-Trading-Arena系统中，每个交易代理（Person）都具备独特的身份属性和角色类型，这些属性共同决定了代理在股票市场中的行为模式、决策逻辑和交互方式。本文件详细描述Person类中的身份属性（identity）和角色类型（如普通代理、经纪人），分析identity字段如何影响代理的行为模式和决策逻辑，以及不同角色在市场中的权限和功能差异。同时，结合代码示例说明身份初始化过程及其在模拟周期中的作用，并分析身份信息如何与提示模板（如gossip.txt、analysis.txt）联动，驱动个性化行为输出。

## 身份属性与角色类型
在系统中，身份属性（identity）是Person类的核心组成部分，存储了代理的基本信息和行为准则。通过`identity`字段，每个代理都具备独特的个人特征，包括职业、投资原则、每日收入、初始现金、最低生活开支和反思频率等。

角色类型主要分为两类：普通代理（Person）和经纪人（Broker）。普通代理代表市场中的个体投资者，具有完整的身份属性和投资策略；而经纪人则作为市场基础设施的一部分，负责股票的首次公开发行（IPO）和市场结算，不具有个人身份属性。

```mermaid
classDiagram
class Person {
+int person_id
+Broker broker
+list stocks
+Database_operate db
+float income
+float cash
+float asset
+float wealth
+str principle
+dict identity
+float minimum_living_expense
+int reflect_frequency
+__init__(person_id, broker, stocks, database, persona_path)
+initialize_person(persona_path)
+create_order(i, op, virtual_date, iteration)
+settlement(order, price, quantity)
+end_of_day(virtual_date, args)
+query_hold_stocks(virtual_date)
+add_memory(virtual_date, iteration, stock_op, type, gossip, analysis_stocks, analysis_strategy, market_index, stocks_list)
+query_memory(virtual_date)
+add_gossip(virtual_date, gossip)
+query_gossip(virtual_date)
}
class Broker {
+int person_id
+list stocks
+Database_operate db
+list inventories
+list dividends
+float cash
+float asset
+float wealth
+float total_expense
+__init__(stocks, database, folder_mem_saved)
+initialize_broker()
+count_expense(expense)
+settlement(order, price, quantity)
+ipo(virtual_date)
+end_of_day(virtual_date)
}
Person --> Broker : "依赖"
Person --> Database_operate : "使用"
Person --> Stock : "持有"
```

**图示来源**
- [Person.py](file://Agent-Trading-Arena/Stock_Main/Person.py#L143-L629)

**本节来源**
- [Person.py](file://Agent-Trading-Arena/Stock_Main/Person.py#L143-L629)
- [persona.json](file://Agent-Trading-Arena/Stock_Main/save/sim_test01/persona.json#L1-L131)

## 身份初始化过程
身份初始化是Person对象创建过程中的关键步骤，通过`initialize_person`方法从JSON配置文件中加载代理的个性化信息。该过程确保了每个代理在进入市场时都具备独特的身份特征和初始状态。

初始化流程如下：
1. 从指定路径加载persona.json文件
2. 根据person_id匹配对应的代理配置
3. 将配置中的属性值赋给Person对象的相应字段
4. 在数据库中创建代理的初始记录

```mermaid
flowchart TD
Start([开始初始化]) --> LoadJSON["加载persona.json文件"]
LoadJSON --> FindPerson["根据person_id查找对应配置"]
FindPerson --> SetAttributes["设置身份属性"]
SetAttributes --> income["income = daily_income_from_job"]
SetAttributes --> principle["principle = principle"]
SetAttributes --> cash["cash = cash"]
SetAttributes --> expense["minimum_living_expense = minimum_living_expense"]
SetAttributes --> reflect["reflect_frequency = reflect_frequency"]
SetAttributes --> CreateDB["在数据库中创建记录"]
CreateDB --> End([初始化完成])
```

**图示来源**
- [Person.py](file://Agent-Trading-Arena/Stock_Main/Person.py#L173-L183)
- [load_json.py](file://Agent-Trading-Arena/Stock_Main/load_json.py#L9-L14)

**本节来源**
- [Person.py](file://Agent-Trading-Arena/Stock_Main/Person.py#L173-L183)
- [load_json.py](file://Agent-Trading-Arena/Stock_Main/load_json.py#L9-L14)
- [persona.json](file://Agent-Trading-Arena/Stock_Main/save/sim_test01/persona.json#L1-L131)

## 身份对行为模式的影响
身份属性中的`principle`字段（投资原则）直接决定了代理的投资策略和决策逻辑。所有代理的初始原则均为"try to maximize profit"（尝试最大化利润），但通过反思机制可以动态调整。

`reflect_frequency`字段控制着代理的自我反思频率，不同值代表不同的角色类型：
- reflect_frequency = 0：普通代理，不进行策略反思
- reflect_frequency = 2, 4, 6：高级代理，定期进行策略反思和调整

反思机制通过以下流程实现：
1. 在指定迭代周期触发反思
2. 调用pre_reflect函数分析历史投资表现
3. 生成策略弱点和优势分析
4. 调用reflect函数生成新的投资策略
5. 更新代理的principle字段

```mermaid
sequenceDiagram
participant Behavior as behavior.py
participant Person as Person
participant Prompt as our_run_gpt_prompt.py
Behavior->>Person : reflection(virtual_date, persons, stocks, market_index, iter, args)
Person->>Person : 检查reflect_frequency
alt 需要反思
Person->>Prompt : pre_reflect(virtual_date, p, args.Save_Path)
Prompt->>Prompt : integrate_reflect_info(virtual_date, persona)
Prompt-->>Person : 返回分析结果
Person->>Prompt : long_reflect(virtual_date, p, args.Save_Path)
Prompt-->>Person : 返回策略建议
Person->>Prompt : update_strategy(virtual_date, p, w_s, suggestion, args.Save_Path)
Prompt-->>Person : 返回新策略
Person->>Person : 更新principle字段
Person->>Person : add_memory(记录反思)
end
```

**图示来源**
- [behavior.py](file://Agent-Trading-Arena/Stock_Main/behavior.py#L174-L198)
- [our_run_gpt_prompt.py](file://Agent-Trading-Arena/Stock_Main/content/our_run_gpt_prompt.py#L114-L327)
- [Person.py](file://Agent-Trading-Arena/Stock_Main/Person.py#L514-L546)

**本节来源**
- [behavior.py](file://Agent-Trading-Arena/Stock_Main/behavior.py#L174-L198)
- [our_run_gpt_prompt.py](file://Agent-Trading-Arena/Stock_Main/content/our_run_gpt_prompt.py#L114-L327)
- [Person.py](file://Agent-Trading-Arena/Stock_Main/Person.py#L514-L546)

## 角色权限与功能差异
系统中的不同角色具有明确的权限和功能划分：

### 普通代理（Person）
- **投资决策权**：根据市场信息和个人策略进行买卖决策
- **信息传播权**：生成和传播市场八卦（gossip）
- **财务自主权**：管理个人现金、资产和日常开支
- **策略反思权**：定期反思并调整投资策略

### 经纪人（Broker）
- **市场管理权**：负责股票的首次公开发行（IPO）
- **结算权**：处理所有交易的财务结算
- **库存管理权**：管理市场初始股票库存
- **无投资权**：不参与市场投资决策

```mermaid
graph TD
subgraph "普通代理功能"
A1[投资决策] --> A2[买卖股票]
A3[信息传播] --> A4[生成八卦]
A5[财务管理] --> A6[收支平衡]
A7[策略反思] --> A8[更新原则]
end
subgraph "经纪人功能"
B1[市场管理] --> B2[IPO发行]
B3[结算处理] --> B4[财务结算]
B5[库存管理] --> B6[股票分配]
B7[无投资] --> B8[不参与交易]
end
A1 --> Market[股票市场]
A4 --> Market
B2 --> Market
B4 --> Market
```

**图示来源**
- [Person.py](file://Agent-Trading-Arena/Stock_Main/Person.py#L143-L629)

**本节来源**
- [Person.py](file://Agent-Trading-Arena/Stock_Main/Person.py#L18-L142)
- [Person.py](file://Agent-Trading-Arena/Stock_Main/Person.py#L143-L629)

## 身份信息与提示模板的联动机制
身份信息通过与多个提示模板的联动，驱动代理的个性化行为输出。系统使用不同的提示模板来引导代理在不同场景下的行为：

### 分析模板（analysis.txt）
用于市场分析，整合以下信息：
- 股票信息
- 市场信息
- 其他代理的八卦
- 现有投资组合
- 投资策略（来自identity.principle）

### 交易决策模板
- **买入决策**（buy_based_on_analysis.txt）：基于分析结果决定买入操作
- **卖出决策**（sell_based_on_analysis.txt）：基于分析结果决定卖出操作

### 反思模板
- **预反思**（pre_reflect.txt）：评估投资策略的优缺点
- **反思**（reflect.txt）：根据评估结果更新投资策略

```mermaid
flowchart LR
Identity[身份信息] --> Analysis["analysis.txt\n(市场分析)"]
Identity --> Gossip["gossip.txt\n(八卦生成)"]
Identity --> Buy["buy_based_on_analysis.txt\n(买入决策)"]
Identity --> Sell["sell_based_on_analysis.txt\n(卖出决策)"]
Identity --> PreReflect["pre_reflect.txt\n(预反思)"]
Identity --> Reflect["reflect.txt\n(策略更新)"]
Analysis --> Decision[交易决策]
Gossip --> Market[市场影响]
PreReflect --> Reflect
Reflect --> UpdatedPrinciple[更新后的投资原则]
UpdatedPrinciple --> Identity
```

**图示来源**
- [analysis.txt](file://Agent-Trading-Arena/Stock_Main/content/our_prompt_template/analysis.txt#L1-L37)
- [gossip.txt](file://Agent-Trading-Arena/Stock_Main/content/our_prompt_template/gossip.txt#L1-L16)
- [buy_based_on_analysis.txt](file://Agent-Trading-Arena/Stock_Main/content/our_prompt_template/buy_based_on_analysis.txt#L1-L33)
- [sell_based_on_analysis.txt](file://Agent-Trading-Arena/Stock_Main/content/our_prompt_template/sell_based_on_analysis.txt#L1-L31)
- [pre_reflect.txt](file://Agent-Trading-Arena/Stock_Main/content/our_prompt_template/pre_reflect.txt#L1-L22)
- [reflect.txt](file://Agent-Trading-Arena/Stock_Main/content/our_prompt_template/reflect.txt#L1-L35)

**本节来源**
- [analysis.txt](file://Agent-Trading-Arena/Stock_Main/content/our_prompt_template/analysis.txt#L1-L37)
- [gossip.txt](file://Agent-Trading-Arena/Stock_Main/content/our_prompt_template/gossip.txt#L1-L16)
- [buy_based_on_analysis.txt](file://Agent-Trading-Arena/Stock_Main/content/our_prompt_template/buy_based_on_analysis.txt#L1-L33)
- [sell_based_on_analysis.txt](file://Agent-Trading-Arena/Stock_Main/content/our_prompt_template/sell_based_on_analysis.txt#L1-L31)
- [pre_reflect.txt](file://Agent-Trading-Arena/Stock_Main/content/our_prompt_template/pre_reflect.txt#L1-L22)
- [reflect.txt](file://Agent-Trading-Arena/Stock_Main/content/our_prompt_template/reflect.txt#L1-L35)

## 模拟周期中的身份作用
在模拟周期中，身份信息贯穿于代理的整个生命周期，发挥着关键作用：

1. **每日开始**：根据身份属性计算日常开支
2. **交易决策**：基于投资原则进行买卖决策
3. **信息传播**：利用身份特征生成个性化八卦
4. **财务结算**：根据收入和开支更新财务状况
5. **策略反思**：按频率进行投资策略反思和更新

每日开支的计算公式体现了身份属性的综合影响：
```
daily_expense = (total_asset * 1.0 + cash) * args.expense_ratio + minimum_living_expense
```

其中，minimum_living_expense直接来自身份配置，确保了不同代理在生活成本上的差异性。

```mermaid
sequenceDiagram
participant DayStart as 每日开始
participant Trading as 交易阶段
participant Gossip as 信息传播
participant Settlement as 财务结算
participant Reflection as 策略反思
loop 每个模拟日
DayStart->>DayStart : 计算daily_expense
DayStart->>Trading : 开始交易
Trading->>Trading : create_order(基于principle)
Trading->>Gossip : add_gossip(基于identity)
Gossip->>Market : 影响其他代理
Trading->>Settlement : settlement(更新财务)
Settlement->>Settlement : end_of_day(更新状态)
alt 需要反思
Settlement->>Reflection : pre_reflect & reflect
Reflection->>Person : 更新principle
end
end
```

**图示来源**
- [Person.py](file://Agent-Trading-Arena/Stock_Main/Person.py#L364-L428)
- [Person.py](file://Agent-Trading-Arena/Stock_Main/Person.py#L514-L546)
- [behavior.py](file://Agent-Trading-Arena/Stock_Main/behavior.py#L174-L198)

**本节来源**
- [Person.py](file://Agent-Trading-Arena/Stock_Main/Person.py#L364-L428)
- [Person.py](file://Agent-Trading-Arena/Stock_Main/Person.py#L514-L546)
- [behavior.py](file://Agent-Trading-Arena/Stock_Main/behavior.py#L174-L198)

## 结论
在Agent-Trading-Arena系统中，身份属性和角色类型构成了代理行为模型的核心。通过`identity`字段，每个代理都具备独特的个人特征和投资原则，这些属性直接影响其行为模式和决策逻辑。

普通代理和经纪人之间的角色分工清晰，权限和功能差异明显。普通代理具有完整的投资决策权和策略反思能力，而经纪人则专注于市场基础设施的维护。

身份信息与多个提示模板的联动机制，实现了从静态配置到动态行为的转化。通过分析、交易、八卦和反思等模板，代理能够基于其身份特征生成个性化的行为输出。

在模拟周期中，身份信息贯穿于代理的整个生命周期，从初始化、日常决策到策略更新，发挥着持续的作用。特别是反思机制，使得代理能够根据市场表现动态调整投资策略，实现了自适应的学习过程。

这种基于身份的代理模型不仅增强了模拟的真实性，也为研究不同投资策略和市场行为提供了灵活的实验平台。