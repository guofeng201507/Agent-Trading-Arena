# 项目概述

<cite>
**本文档引用的文件**
- [README.md](file://README.md)
- [main.py](file://Agent-Trading-Arena/Stock_Main/main.py)
- [Person.py](file://Agent-Trading-Arena/Stock_Main/Person.py)
- [Stock.py](file://Agent-Trading-Arena/Stock_Main/Stock.py)
- [Market.py](file://Agent-Trading-Arena/Stock_Main/Market.py)
- [behavior.py](file://Agent-Trading-Arena/Stock_Main/behavior.py)
- [database_utils.py](file://Agent-Trading-Arena/Stock_Main/database_utils.py)
- [load_json.py](file://Agent-Trading-Arena/Stock_Main/load_json.py)
- [run.sh](file://Agent-Trading-Arena/run.sh)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [系统架构与工作流程](#系统架构与工作流程)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能与持久化](#性能与持久化)
8. [使用与实验](#使用与实验)
9. [结论](#结论)

## 简介

Agent-Trading-Arena 是一个基于大语言模型（LLM）的多智能体股票交易模拟系统，旨在创建一个闭环、无先验知识的人类化交易环境，用于评估和推进具备自我博弈能力的金融智能体。该项目通过LLM驱动的智能体模拟真实市场行为，包括市场分析、交易决策、信息传播（八卦）和策略反思机制。

系统通过多个LLM智能体（Person）在模拟股票市场中进行交互，每个智能体具有独特的身份、财务状况和投资原则。智能体基于市场数据、个人记忆和从其他智能体获得的八卦信息，通过调用LLM生成交易决策。系统还实现了智能体的反思机制，使其能够根据交易结果调整投资策略，从而模拟真实投资者的学习过程。

该项目为金融行为研究、算法交易策略测试和LLM在复杂决策环境中的应用提供了强大的实验平台。

**Section sources**
- [README.md](file://README.md#L1-L52)

## 项目结构

Agent-Trading-Arena 项目采用模块化设计，主要组件包括智能体（Person）、股票（Stock）、市场（Market）和行为逻辑（behavior）。系统使用SQLite数据库进行数据持久化，并通过JSON文件初始化智能体和股票的配置。

```mermaid
graph TB
subgraph "核心模块"
Person[Person.py<br>智能体管理]
Stock[Stock.py<br>股票管理]
Market[Market.py<br>市场撮合]
Behavior[behavior.py<br>行为决策]
end
subgraph "数据与工具"
Database[database_utils.py<br>数据库操作]
LoadJson[load_json.py<br>配置加载]
Content[content/<br>提示词模板]
Save[save/<br>数据持久化]
end
subgraph "入口与配置"
Main[main.py<br>主程序]
Run[run.sh<br>运行脚本]
Readme[README.md<br>项目说明]
end
Main --> Person
Main --> Stock
Main --> Market
Main --> Behavior
Main --> Database
Main --> LoadJson
Behavior --> Database
Person --> Database
Stock --> Database
Market --> Database
LoadJson --> Person
LoadJson --> Stock
Content --> Behavior
Save --> Main
Run --> Main
```

**Diagram sources**
- [main.py](file://Agent-Trading-Arena/Stock_Main/main.py#L1-L151)
- [Person.py](file://Agent-Trading-Arena/Stock_Main/Person.py#L1-L629)
- [Stock.py](file://Agent-Trading-Arena/Stock_Main/Stock.py#L1-L307)
- [Market.py](file://Agent-Trading-Arena/Stock_Main/Market.py#L1-L278)
- [behavior.py](file://Agent-Trading-Arena/Stock_Main/behavior.py#L1-L210)

**Section sources**
- [main.py](file://Agent-Trading-Arena/Stock_Main/main.py#L1-L151)
- [Person.py](file://Agent-Trading-Arena/Stock_Main/Person.py#L1-L629)
- [Stock.py](file://Agent-Trading-Arena/Stock_Main/Stock.py#L1-L307)
- [Market.py](file://Agent-Trading-Arena/Stock_Main/Market.py#L1-L278)
- [behavior.py](file://Agent-Trading-Arena/Stock_Main/behavior.py#L1-L210)
- [database_utils.py](file://Agent-Trading-Arena/Stock_Main/database_utils.py#L1-L322)
- [load_json.py](file://Agent-Trading-Arena/Stock_Main/load_json.py#L1-L134)

## 核心组件

项目的核心组件包括智能体（Person）、股票（Stock）、市场（Market）和行为逻辑（behavior），它们协同工作以模拟真实的股票交易环境。

**Section sources**
- [Person.py](file://Agent-Trading-Arena/Stock_Main/Person.py#L1-L629)
- [Stock.py](file://Agent-Trading-Arena/Stock_Main/Stock.py#L1-L307)
- [Market.py](file://Agent-Trading-Arena/Stock_Main/Market.py#L1-L278)
- [behavior.py](file://Agent-Trading-Arena/Stock_Main/behavior.py#L1-L210)

## 系统架构与工作流程

该系统采用基于LLM的多智能体架构，通过模拟每日多次迭代的交易过程来重现市场动态。工作流程从初始化市场环境开始，经过智能体决策、订单撮合、交易结算到数据持久化。

```mermaid
sequenceDiagram
participant Main as main.py
participant Market as Market
participant Person as Person
participant Behavior as behavior
participant LLM as LLM API
participant DB as Database
Main->>Main : get_args() 解析参数
Main->>Main : init_all() 初始化系统
loop 每个交易日
Main->>Market : update_market_index()
Main->>Behavior : generate_gossip() 生成八卦
loop 每日多次迭代
Main->>Behavior : stock_ops() 获取交易操作
Behavior->>Person : analysis() 市场分析
Person->>LLM : 调用LLM生成分析
LLM-->>Person : 返回分析结果
Behavior->>Person : run_gpt_prompt_choose_buy/sell
Person->>LLM : 调用LLM生成交易决策
LLM-->>Person : 返回买卖决策
Behavior-->>Main : 返回交易操作列表
Main->>Market : create_order() 创建订单
Main->>Market : match_order() 撮合订单
Market->>DB : update_trade_data() 更新交易数据
Main->>Market : end_of_market() 市场收盘
Main->>Behavior : reflection() 反思机制
Behavior->>Person : pre_reflect/long_reflect
Person->>LLM : 调用LLM进行反思
LLM-->>Person : 返回反思结果
Behavior->>Person : update_strategy() 更新策略
Main->>Main : save_all() 保存状态
end
Main->>Market : end_of_day() 日终结算
Main->>Person : end_of_day() 智能体日终结算
Main->>Stock : end_of_day() 股票日终结算
end
```

**Diagram sources**
- [main.py](file://Agent-Trading-Arena/Stock_Main/main.py#L99-L147)
- [behavior.py](file://Agent-Trading-Arena/Stock_Main/behavior.py#L82-L171)
- [Market.py](file://Agent-Trading-Arena/Stock_Main/Market.py#L96-L199)

**Section sources**
- [main.py](file://Agent-Trading-Arena/Stock_Main/main.py#L1-L151)
- [behavior.py](file://Agent-Trading-Arena/Stock_Main/behavior.py#L82-L210)
- [Market.py](file://Agent-Trading-Arena/Stock_Main/Market.py#L1-L278)

## 详细组件分析

### 智能体（Person）分析

智能体是系统的核心决策单元，每个智能体都是一个LLM驱动的实体，具有独立的身份、财务状况和投资策略。智能体通过与环境交互，基于市场信息和个人记忆做出交易决策。

```mermaid
classDiagram
class Person {
+int person_id
+float cash
+float asset
+float wealth
+dict identity
+int reflect_frequency
+initialize_person(persona_path)
+create_order(i, op, virtual_date, iteration)
+settlement(order, price, quantity)
+end_of_iteration(virtual_date, iteration)
+end_of_day(virtual_date, args)
+query_hold_stocks(virtual_date)
+query_single_stock(virtual_date, stock_id)
+query_account(virtual_date)
+add_memory(virtual_date, iteration, ...)
+query_memory(virtual_date)
+add_gossip(virtual_date, gossip)
+query_gossip(virtual_date)
}
class Broker {
+int person_id
+list inventories
+list dividends
+float cash
+float asset
+float wealth
+float total_expense
+initialize_broker()
+count_expense(expense)
+settlement(order, price, quantity)
+ipo(virtual_date)
+end_of_day(virtual_date)
}
Person --> Broker : "继承"
Person --> Database_operate : "使用"
Person --> Stock : "持有"
Broker --> Stock : "管理"
```

**Diagram sources**
- [Person.py](file://Agent-Trading-Arena/Stock_Main/Person.py#L18-L629)

**Section sources**
- [Person.py](file://Agent-Trading-Arena/Stock_Main/Person.py#L1-L629)

### 股票（Stock）分析

股票组件负责管理单个股票的状态和交易数据，包括价格、成交量、市值等关键指标。每个股票实例维护其价格历史和日内交易数据。

```mermaid
classDiagram
class Stock {
+str Name
+int stock_id
+float current_price
+str stock_name
+int quantity
+float book_value
+float DPS
+list intraday_price_list
+Database_operate db
+initialize_stock(stock_path)
+end_of_day(virtual_date)
+update_trade_data(virtual_date, price, quantity)
+query_price(virtual_date)
+query_intraday_percentage(virtual_date)
+query_daily_return(virtual_date, no_days)
+query_prompt_values(virtual_date, no_days)
}
class Market_index {
+str Name
+int stock_id
+Database_operate db
+list stocks
+list stock_proportion
+end_of_day(virtual_date)
+update_market_index(virtual_date)
+query_market_index(virtual_date)
+query_market_index_intraday_percentage(virtual_date)
}
Stock --> Database_operate : "使用"
Market_index --> Stock : "聚合"
Market_index --> Database_operate : "使用"
```

**Diagram sources**
- [Stock.py](file://Agent-Trading-Arena/Stock_Main/Stock.py#L14-L307)

**Section sources**
- [Stock.py](file://Agent-Trading-Arena/Stock_Main/Stock.py#L1-L307)

### 市场（Market）分析

市场组件负责订单撮合和价格形成，是整个交易系统的核心引擎。它实现了限价订单簿的撮合逻辑，并根据交易量和价格更新市场状态。

```mermaid
flowchart TD
Start([开始撮合]) --> FetchOrders["获取买卖订单"]
FetchOrders --> SortOrders["按价格排序"]
SortOrders --> CheckPriceLimit["检查价格涨跌幅限制"]
CheckPriceLimit --> |在限制内| CalculateDealPrice["计算成交价"]
CalculateDealPrice --> UpdateStockPrice["更新股票价格"]
UpdateStockPrice --> UpdateTradeData["更新交易数据"]
UpdateTradeData --> UpdateOrderStatus["更新订单状态"]
UpdateOrderStatus --> CheckPartial["检查部分成交"]
CheckPartial --> |是| UpdateRemainingOrder["更新剩余订单"]
CheckPartial --> |否| NextOrder["处理下一订单"]
NextOrder --> End([撮合结束])
UpdateRemainingOrder --> End
```

**Diagram sources**
- [Market.py](file://Agent-Trading-Arena/Stock_Main/Market.py#L96-L199)

**Section sources**
- [Market.py](file://Agent-Trading-Arena/Stock_Main/Market.py#L1-L278)

### 行为逻辑（behavior）分析

行为逻辑组件是连接智能体与LLM的桥梁，负责将市场信息转化为LLM可理解的提示词，并解析LLM的输出为具体的交易操作。

```mermaid
flowchart TD
Start([开始行为决策]) --> StockOps["stock_ops()"]
StockOps --> LoopPerson["遍历每个智能体"]
LoopPerson --> Analysis["analysis() 市场分析"]
Analysis --> CallLLM1["调用LLM进行分析"]
CallLLM1 --> ChooseBuy["run_gpt_prompt_choose_buy_stock()"]
ChooseBuy --> CallLLM2["调用LLM生成买入决策"]
CallLLM2 --> ExtractBuy["extract_for_choose_buy()"]
ExtractBuy --> ChooseSell["run_gpt_prompt_choose_sell_stock()"]
ChooseSell --> CallLLM3["调用LLM生成卖出决策"]
CallLLM3 --> ExtractSell["extract_for_choose_sell()"]
ExtractSell --> AddMemory["p.add_memory() 记录决策"]
AddMemory --> ReturnOps["返回操作列表"]
ReturnOps --> End([行为决策结束])
Reflection["reflection() 反思机制"] --> LoopPerson2["遍历每个智能体"]
LoopPerson2 --> CheckFrequency["检查反思频率"]
CheckFrequency --> |需要反思| PreReflect["pre_reflect()"]
PreReflect --> CallLLM4["调用LLM进行初步反思"]
CallLLM4 --> LongReflect["long_reflect()"]
LongReflect --> CallLLM5["调用LLM进行深度反思"]
CallLLM5 --> UpdateStrategy["update_strategy()"]
UpdateStrategy --> CallLLM6["调用LLM更新策略"]
UpdateStrategy --> UpdatePrinciple["p.principle = new_strategy"]
UpdatePrinciple --> AddMemory2["p.add_memory() 记录反思"]
AddMemory2 --> End2([反思结束])
```

**Diagram sources**
- [behavior.py](file://Agent-Trading-Arena/Stock_Main/behavior.py#L82-L210)

**Section sources**
- [behavior.py](file://Agent-Trading-Arena/Stock_Main/behavior.py#L1-L210)

## 依赖关系分析

系统各组件之间存在紧密的依赖关系，形成了一个完整的交易模拟闭环。通过依赖分析可以清晰地看到数据流和控制流的走向。

```mermaid
graph TD
Main[main.py] --> Person
Main --> Stock
Main --> Market
Main --> Behavior
Main --> DatabaseUtils
Main --> LoadJson
Person --> DatabaseUtils
Person --> LoadJson
Person --> Content
Stock --> DatabaseUtils
Stock --> LoadJson
Market --> DatabaseUtils
Behavior --> DatabaseUtils
Behavior --> Content
DatabaseUtils --> SQLite[(SQLite)]
LoadJson --> JSON[(JSON配置)]
Content --> LLM[(LLM API)]
style Main fill:#f9f,stroke:#333
style SQLite fill:#ccf,stroke:#333
style JSON fill:#cfc,stroke:#333
style LLM fill:#fcc,stroke:#333
```

**Diagram sources**
- [main.py](file://Agent-Trading-Arena/Stock_Main/main.py#L1-L151)
- [database_utils.py](file://Agent-Trading-Arena/Stock_Main/database_utils.py#L246-L322)
- [load_json.py](file://Agent-Trading-Arena/Stock_Main/load_json.py#L1-L134)

**Section sources**
- [main.py](file://Agent-Trading-Arena/Stock_Main/main.py#L1-L151)
- [database_utils.py](file://Agent-Trading-Arena/Stock_Main/database_utils.py#L1-L322)
- [load_json.py](file://Agent-Trading-Arena/Stock_Main/load_json.py#L1-L134)

## 性能与持久化

系统通过SQLite数据库实现数据持久化，确保模拟过程中的所有状态可以被保存和恢复。数据持久化机制覆盖了智能体状态、股票价格、交易记录和市场信息。

```mermaid
erDiagram
PERSON {
int person_id PK
int virtual_date PK
float cash
float asset
float wealth
float work_income
float capital_gain
float daily_expense
text principle
}
STOCK {
int stock_id PK
int virtual_date PK
int weekday
float volume
float quantity
float last_price
float begin_price
float highest_price
float lowest_price
}
ACTIVE_ORDERS {
int timestamp PK
int virtual_date
int weekday
int iteration
int stock_id FK
int person_id FK
text type
float price
int quantity
text status
}
ACCOUNT {
int person_id PK
int stock_id PK
int virtual_date PK
int weekday
int quantity
float cost_price
float current_price
float profit
int start_date
}
MEMORY {
int person_id PK
int virtual_date PK
int iteration PK
text stock_operations
text strategy
text type
text gossip
text analysis_for_stocks
text analysis_for_strategy
text stock_prices
text market_change
text financial_situation
}
GOSSIP {
int person_id PK
int virtual_date PK
text gossip
}
PERSON ||--o{ ACCOUNT : "拥有"
PERSON ||--o{ MEMORY : "记录"
PERSON ||--o{ GOSSIP : "传播"
STOCK ||--o{ ACTIVE_ORDERS : "关联"
STOCK ||--o{ ACCOUNT : "关联"
```

**Diagram sources**
- [database_utils.py](file://Agent-Trading-Arena/Stock_Main/database_utils.py#L254-L300)
- [main.py](file://Agent-Trading-Arena/Stock_Main/main.py#L78-L85)
- [load_json.py](file://Agent-Trading-Arena/Stock_Main/load_json.py#L45-L69)

**Section sources**
- [database_utils.py](file://Agent-Trading-Arena/Stock_Main/database_utils.py#L1-L322)
- [main.py](file://Agent-Trading-Arena/Stock_Main/main.py#L1-L151)
- [load_json.py](file://Agent-Trading-Arena/Stock_Main/load_json.py#L1-L134)

## 使用与实验

项目提供了清晰的使用指南，用户可以通过运行脚本快速启动模拟实验。系统支持多种参数配置，以适应不同的实验需求。

```mermaid
flowchart TD
Start([开始]) --> Preparation["准备工作"]
Preparation --> Clone["git clone 项目"]
Clone --> Install["pip install -r requirement.txt"]
Install --> SetAPI["设置OpenAI API密钥"]
SetAPI --> Run["运行模拟"]
Run --> Execute["sh run.sh"]
Execute --> Configure["修改run.sh中的参数"]
Configure --> Monitor["监控模拟过程"]
Monitor --> Analyze["分析结果数据"]
Analyze --> End([结束])
style Start fill:#f96,stroke:#333
style End fill:#f96,stroke:#333
style Execute fill:#6f9,stroke:#333
```

**Diagram sources**
- [run.sh](file://Agent-Trading-Arena/run.sh#L1-L24)
- [README.md](file://README.md#L18-L40)

**Section sources**
- [run.sh](file://Agent-Trading-Arena/run.sh#L1-L24)
- [README.md](file://README.md#L1-L52)

## 结论

Agent-Trading-Arena 项目成功构建了一个基于LLM的多智能体股票交易模拟系统，通过智能体的自主决策、信息传播和策略反思，有效模拟了真实市场的复杂动态。系统架构清晰，组件职责分明，为金融行为研究和算法交易策略测试提供了强大的实验平台。

该项目的创新之处在于将LLM作为智能体的决策核心，使其能够理解复杂的市场信息并生成合理的交易策略。同时，系统实现了完整的交易生命周期管理，包括订单撮合、价格形成、日终结算和数据持久化。

未来的研究方向可以包括引入更多市场参与者类型、增加市场事件模拟、优化LLM提示词设计以提高决策质量，以及扩展系统以支持更复杂的金融产品。